---
title: "ETC 1010 Lab 6"
output: html_document
---

```{r, echo = FALSE, message = FALSE, warning = FALSE, warning = FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  error = FALSE, 
  collapse = TRUE,
  echo=FALSE,
  comment = "",
  fig.height = 8,
  fig.width = 12,
  fig.align = "center",
  cache = FALSE
)
```

```{r echo=FALSE}
library(tidyverse)
library(forcats)
```

# Instructions

In this week's lab, the main goal is to pull data together from multiple excel sheets, explore and impute missing values.  On the due date, turn in your Rmd file and the html product. 

## Exercise 1

Open your project for this class. Make sure all your work is done relative to this project.

Open the `lab6.Rmd` file provided with the instructions. You can edit this file and add your answers to questions in this document.


## Exercise 2

In the lecture notes, we pulled data about rentals in Hobart. This is the code that pulls the data together. 

```{r echo=TRUE}
library(readxl)
library(sawfish) # devtools::install_github("AnthonyEbert/sawfish")
url<-"http://data.gov.au/dataset/rental-bond-and-rental-data-tasmania-2016-to-2017"
fls <- find_files(url, "xlsx")
f1 <- tempfile()
rentals <- NULL
for (i in 1:length(fls)) {
  download.file(fls[i], f1, mode="wb")
  t1 <- read_xlsx(path=f1, sheet=1)
  rentals <- bind_rows(rentals, t1)
}
```

a. (2pts) Check the data format using the `visdat` package. What types of variables are there in the data?

```{r}
library(visdat)
vis_dat(rentals)
```
`character, numeric, date`

b. (2pts) From the visdat heatmap, summarise the missing data patterns.

```{r}
library(naniar)
vis_miss(rentals)
```

`Street name, and Bond status are mostly missings. No of Bedrooms has also a lot of missings, 20%`

c. (3pts) Using the `naniar` package, numerically summarise missings. What proportion of the overall data are missing? What proportion of variables have missings? What fraction of cases have 0, 1, 2, ... missings? It could be useful to also make the missingness map (as done in the lectures).

```{r}
s_miss <- miss_summary(rentals)
s_miss_cases <- s_miss$miss_case_table
```

`r s_miss$miss_df_prop*100` % of the overall data is missing. `r s_miss$miss_var_prop*100` % of the variables have missings. `r s_miss_cases[[1]]$percent[1]` have one missing case, `r s_miss_cases[[1]]$percent[2]` have two missing cases, and `r s_miss_cases[[1]]$percent[3]` have three missing cases. 

d. (2pts) Determine an appropriate strategy for dealing with the missing values. And go ahead an implement your strategy.

```{r}
rentals <- rentals %>% select(-`Street Name`, -`Bond Status`)
```

`Drop the two variables Street name, and Bond status. Impute missings for No of bedrooms, because this variable is too important to discard in relation to rental price. We may need to use suburb, or price, to make good imputations.`

e. (2pts) Make a plot of weekly rent by number of bedrooms, with missings plotted in the margins. Describe the distribution of rent, based on missing or not of bedrooms. 

```{r}
ggplot(rentals, aes(x=`No of Bedrooms`, y=`Weekly Rent`)) + 
  geom_miss_point() + scale_color_brewer(palette="Dark2")
```

`The cases with missings on No of bedrooms are very spread on price. Probably the distribution of price is similar for missings vs not missing on bedrooms.`

f. (3pts) Count the number of rental units in each suburb, and sort in decreasing order. What suburb has the most rental units available, at least according to this data? Make a histogram of the counts. Describe the distribution of counts.

```{r}
rentals %>% count(Suburb, sort=TRUE) %>% head(1)
rentals %>% count(Suburb, sort=TRUE) %>% 
  ggplot(aes(x=n)) + geom_histogram(binwidth=50)
```

`HOBART has the most rentals. The distribution of rental numbers by suburb is very right skewed. There are a couple of suburbs with lots of rentals, but most suburbs tend to have between 0-100 rental properties. `

g. (2pts) Working only with suburbs with more than 200 rentals, examining the relationship with missings on bedrooms. Are the missing values distributed uniformly across suburbs? (Make a plot to support your argument.)

```{r}
suburb_count <- rentals %>% count(Suburb, sort=TRUE)
keep <- suburb_count %>% filter(n>200) %>% select(Suburb)
rentals_shadow <- rentals %>% 
  filter(Suburb %in% keep$Suburb) %>%
  bind_shadow() %>%
  select(Suburb:`Dwelling/Premises Type`,`No of Bedrooms_NA`) %>%
  mutate(Suburb = factor(Suburb, levels=keep$Suburb))
ggplot(rentals_shadow, 
       aes(x=`Suburb`, fill=`No of Bedrooms_NA`)) + 
  geom_bar(position="fill") + scale_fill_brewer(palette="Dark2") + coord_flip()
```

`This plot shows the proportion of missing by suburb. Some suburbs have as few as 5% missing, and others 40% missing. This suggests that missings may not be uniformly distributed across suburbs. (However, it could be argued that we might see this large a disparity if we were sampling from a uniform distribution. But this is a topic best left for ETC2420.)`

Continue working with the subset of suburbs with more than 200 rentals. 

h. (2pts) Now we will attempt to impute the missing values. The easiest is probably nearest neighbours. Explain how you can use the nearest neighbours approach here for this data, and special ways that you will need to modify the procedure. For example, nearest neighbors can only use numerical variables to find the closest neighbours. And also, if you average the number of bedrooms, the result may not be an integer. Now implement it.

```{r}
#source("https://bioconductor.org/biocLite.R")
#biocLite("impute")
library(impute)
rentals_impute <- rentals_shadow %>%
  select(`Bond Amount`, `Weekly Rent`, `No of Bedrooms`) 
rentals_impute <- impute.knn(as.matrix(rentals_impute), 5)
rentals_impute <- as_tibble(rentals_impute$data) %>%
  mutate(`No of Bedrooms` = round(`No of Bedrooms`, 0))
rentals_impute <- bind_cols(rentals_impute, 
  select(rentals_shadow, Suburb, Postcode, 
         `Bond Lodgement date (DD/MM/YYYY)`, `Dwelling/Premises Type`))
```

`Points are awarded for the code provided.`

i. Now answer some questions about rentals in Tasmania.

   I. (2pts) What are the different dwelling types?
   
```{r}
rentals_impute %>% count(`Dwelling/Premises Type`)
```

`Primarily flats, and separate houses. There are some townhouses. There are lot with this information missing, simply specified as OTHERS or UNSPECIFIED.`

  II (2pts) For flats, compute the average rental by bedrooms. What would you expect to pay for a four bedroom flat, on average?
  
```{r}
rentals_impute %>% 
  filter(`Dwelling/Premises Type` == "FLAT OR UNIT OR APARTMENT") %>%
  group_by(`No of Bedrooms`) %>%
  summarise(av_rent = mean(`Weekly Rent`))
```

`About $435 weekly rent for a four bedroom flat.`

  III (2pts) What suburb has the highest average weekly rent for a four bedroom flat?

```{r}
rentals_impute %>% 
  filter(`Dwelling/Premises Type` == "FLAT OR UNIT OR APARTMENT") %>%
  group_by(`No of Bedrooms`, Suburb) %>%
  summarise(av_rent = mean(`Weekly Rent`)) %>%
  filter(`No of Bedrooms` == 4) %>%
  arrange(desc(av_rent))
```

`HOBART by far.`

  IV If you found a lovely four bedroom flat, in a nice location in HOBART, and the rental price being asked was $520 per week, would you grab it as a bargain for you and three friends?

`Definitely! The average rent across all properties is $611 in HOBART. So a 4 bed in nice location at $520 is a bargain.`
