---
title: "london Smart Meter Data"
author: 5T
date: "Week 12"
output:
  xaringan::moon_reader:
    css: ["default","myremark.css"]
    self_contained: false
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r, echo=FALSE}
#devtools::install_github("yihui/xaringan")
```
# 1. Data and Questions

## Our Data

- Smart Meter Data from Kaggle
- Records usage information every 30 minutes
- Sends the useage information electronicly to the energy company
- Data only provided for every second day

---
## Data information
- sample of 5567 households in London from November 2011 to February 2014.
The data set contains information on:
-	energy consumption in kWh (per half hour and daily)
-	unique household identifier
-	date and time
-	CACI Acorn group (demographics)
-	weather (hourly and daily):

---

## Data Cleaning

- The half hourly data was provided in 110 seperate csv files
- Each csv file had ~30,000 rows, each with a day of half hourly data
- merge these datasets
- give each half hourly observation its own row and add some information about each hosehold

---

##Data Cleaning

- More than 160,000,000 rows of data
- More than 1.2 Billion observed values 
- Could not save all of the data in one file 
- Four very wealthy, and four disadvantaged households were selected
- Two households on time of use tariffs and two households on standard tariffs

```{r eval=FALSE, include=FALSE}
#This code was used to clean the data
library(tidyverse)
info=read_csv("data/smart-meters-in-london/informations_households.csv")

filea=NULL
#first 40 csv files
for (i in 1:40) {
 f1=read_csv(paste0("data/smart-meters-in-london/hhblock_dataset/block_", i-1 , ".csv"))
 f1<-f1%>%
   gather(time,kwh,-LCLid,-day) %>% 
   mutate(time=as.numeric(sub("hh_","",time)))
 filea=bind_rows(filea, f1)
}


filea = left_join(filea,info,by="LCLid")

saveRDS(filea,file="data/dataPart1.rda")

#filea removed from memory to ensure RAM availble for next stages of processing
filea=NULL

fileb=NULL

for (i in 41:80) {
  f1=read_csv(paste0("data/smart-meters-in-london/hhblock_dataset/block_", i-1 , ".csv"))
  f1<-f1%>%
    gather(time,kwh,-LCLid,-day) %>% 
    mutate(time=as.numeric(sub("hh_","",time)))
  fileb=bind_rows(fileb, f1)
}

fileb = left_join(fileb,info,by="LCLid")

saveRDS(fileb,file="data/dataPart2.rda")
fileb=NULL

filec=NULL

for (i in 81:112) {
  f1=read_csv(paste0("data/smart-meters-in-london/hhblock_dataset/block_", i-1 , ".csv"))
  f1<-f1%>%
    gather(time,kwh,-LCLid,-day) %>% 
    mutate(time=as.numeric(sub("hh_","",time)))
  filec=bind_rows(filec, f1)
}


filec = left_join(filec,info,by="LCLid")
saveRDS(filec,file="data/dataPart3.rda")
filec=NULL
f1=NULL
info=NULL
#select and save requrired observations
file1=readRDS("data/dataPart1.rda")
file1 =file1 %>% filter(LCLid == c("MAC003566","MAC003449","MAC005160","MAC004436")) 
file2=readRDS("data/dataPart3.rda")
file2=file2 %>% filter(LCLid==c("MAC005547","MAC002234","MAC000236","MAC000635"))
newfile=rbind(file1,file2)
saveRDS(newfile,file="data/eightHouseholds.rda")

```
---
## Questions to explore
1. If there are variables which affects energy usage across all ACORN A household's energy consumption. 
2. We wish to look at the specific driving forces behind the energy usage for specific ACORN A households, with a particular emphasis on the type of tariffs charged to each household. 
3. Compare these results to those of another ACORN group.
We have decided to analyse from 4 ACORN A households. Two of which are on a standard tariff and two on a time of use (ToU) tariff.



---
# 3. DATA ANALYSIS

```{r, echo=FALSE}
data <- readRDS("eightHouseholds.rda")
```
```{r, include=FALSE}
library(ggplot2)
library(sugrrants)
library(dplyr)
library(tidyverse)
library(broom)
```
---
# 3. DATA ANALYSIS
## Data visualisation 
### Box plot
---
```{r, echo=FALSE}
#summary(data)
data1 <- data %>% filter(Acorn == "ACORN-A")
#summary(data1)
ggplot(data1, aes(x = LCLid, y=kwh))+
  geom_boxplot() +
  geom_hline(yintercept = mean(data1$kwh), slope = 0, colour = "red") +coord_flip()
```
- ToU tariff have a lower median energy consumption; more than 50% of those households consume less than overall average energy consumption
---
### Calendar graphs
---
#### Standard tariff household in ACORN-A
```{r, echo=FALSE}
#this household is standard tariffs
data3449 <- data %>% filter(LCLid == "MAC003449")
data3449 <- data3449 %>% mutate(time_hourly = time/2) %>%
  frame_calendar(x = time_hourly, y=kwh, date = day)
q <- data3449 %>%
  ggplot(aes(x = .time_hourly, y = .kwh, group = day)) +
  geom_line() +
  theme(legend.position = "bottom")
prettify(q, label.padding = unit(0.08, "lines"))
```

---
#### Standard tariff household in ACORN-A
```{r, echo=FALSE}
#this household is standard tariffs
data3566 <- data %>% filter(LCLid == "MAC003566")
data3566 <- data3566 %>% mutate(time_hourly = time/2) %>%
  frame_calendar(x = time_hourly, y=kwh, date = day)
w <- data3566 %>%
  ggplot(aes(x = .time_hourly, y = .kwh, group = day)) +
  geom_line() +
  theme(legend.position = "bottom")
prettify(w, label.padding = unit(0.08, "lines"))
```
---
#### ToU tariff household in ACORN-A
```{r, echo=FALSE}
#this household is tou tariffs
data5160 <- data %>% filter(LCLid == "MAC005160")
data5160 <- data5160 %>% mutate(time_hourly = time/2) %>%
  frame_calendar(x = time_hourly, y=kwh, date = day)
r<- data5160 %>%
  ggplot(aes(x = .time_hourly, y = .kwh, group = day)) +
  geom_line() +
  theme(legend.position = "bottom")
prettify(r, label.padding = unit(0.08, "lines"))
#it is possibly more interesting if we look more in depth at a specific day to see usage based on time of day
```
---
#### ToU tariff household in ACORN-A
```{r, echo=FALSE}
#this household is another tou tariffs
data3903 <- data %>% filter(LCLid == "MAC004436")
data3903 <- data3903 %>% mutate(time_hourly = time/2) %>%
  frame_calendar(x = time_hourly, y=kwh, date = day)
e <- data3903 %>%
  ggplot(aes(x = .time_hourly, y = .kwh, group = day)) +
  geom_line() +
  theme(legend.position = "bottom")
prettify(e, label.padding = unit(0.08, "lines"))
```
---
Standard tariff:
- more electricity usage during winter (Nov - Feb)
ToU tariff:
- difference between summer and winter is not as big. 
- overall less energy consumption
---
Model of time
```{r}
mod_time <- lm(kwh~time, data1)
tidy(mod_time)
glance(mod_time)
```
Adding time rather than the dummy variable daytime proves to be better, supported by mod_time having a higher r squared value and lower AIC value. Therefore using time alone as a variable is a better option
---
###Trialling with more variables
###Adding interaction terms
#### between day and tariff
```{r, echo=FALSE}
mod2<- lm(kwh ~ day*LCLid, data1)
tidy(mod2)
glance(mod2)
```
By adding an interaction term we see that r squared has improved but not by a drastic amount, however the model is still inaccurate in explaining the variation in energy comsumption. 

---
###Splitting the day variable into individual components

```{r, echo=FALSE, include=FALSE}
data2 <- cbind(data1, day2=rep(data1$day))
data2 <- data2 %>%
  separate(day2, c("Year","Month","Day"), "-")
```

```{r, echo=FALSE, include=FALSE}
library(lubridate)
data3 <- data2%>%
  mutate(wday = wday(data2$day, label = TRUE, abbr = FALSE))
data3 <- data3 %>%
  mutate(Wed = ifelse(wday == "Wednesday", 1, 0)) %>%
  mutate(Thu = ifelse(wday == "Thursday", 1, 0)) %>%
  mutate(Fri = ifelse(wday == "Friday", 1, 0)) %>%
  mutate(Sat = ifelse(wday == "Saturday", 1, 0)) %>%
  mutate(Sun = ifelse(wday == "Sunday", 1, 0)) %>%
  mutate(Mon = ifelse(wday == "Monday", 1, 0)) %>%
  mutate(Tue = ifelse(wday == "Tuesday", 1, 0))
```
```{r}
mod5 <- lm (kwh~Year+Month+Wed+Thu+Fri+Sat+Sun+Mon+Tue+LCLid, data = data3)
glance(mod5)
```
Including weekdays using mutate provides a better model than just using days

---
###Interaction terms
```{r}
mod6 <- lm (kwh~Year+Month+Sat+Sun+LCLid*time, data = data3)
glance(mod6)
```
It seems intuitive that LCLid will have some correlation with time as households are split into ToU or standard. 
---
###Interaction with Month and Time
```{r}
mod9 <- lm (kwh~Year+Month+Sat+Sun+time*LCLid + LCLid*Month, data = data3)
glance(mod9)
```

Adding interaction terms not only improves the R squared value but also decreases the AIC. Where increasing regressors are penalised, however still results in a lower AIC hence mod9 the best model by far.

---
###Best Model

```{r}
mod11 <- lm (kwh~Year+Month+Sat+Sun+time*LCLid + LCLid*Month + LCLid*Year + LCLid*Mon+LCLid*Tue+LCLid*Wed+LCLid*Thu+LCLid*Fri+LCLid*Sat+LCLid*Sun, data = data3)
glance(mod11)
```

This accounts for around 60% of the variation within the data by interacting LCLid by each variable related to date.
---

```{r}
library(broom)
mod11_aug <- augment(mod11, data3)
ggplot(mod11_aug, aes(x=.fitted, y=.std.resid)) + 
  geom_point() 
```

---
##Comparison between different ACORNS 
---
```{r, echo=FALSE}
ggplot(data, aes(x=LCLid, y=kwh)) + 
  geom_boxplot() + 
  geom_hline(yintercept = mean(data$kwh), slope = 0, colour = "red")+
  facet_wrap(~Acorn)+ 
  coord_flip()
```
75% of there energy consumption below the overall average energy consumption across the two groups
---
```{r, echo=FALSE}
data_acornq <- data %>% filter(Acorn == "ACORN-Q")
ggplot(data_acornq, aes(x=LCLid, y=kwh)) + 
  geom_boxplot() + 
  geom_hline(yintercept = mean(data_acornq$kwh), slope = 0, colour = "red")+
  facet_wrap(~Acorn)+ 
  coord_flip()
```
- ToU tariff consume at least 75% of there energy below the average consumption of ACORN-Q households
- more positively skewed compared to ACORN-A
---

acorn_mod <- lm(kwh~Acorn, data)
```{r, echo=FALSE}
acorn_mod <- lm(kwh~Acorn, data)
tidy(acorn_mod)
glance(acorn_mod)
```
This generally proves that households in ACORN-Q use less energy on average than those in ACORN-A by 0.3 kwh per half hour. 

---
acorn_mod1 <- lm(kwh~Acorn*LCLid, data)
```{r, echo=FALSE}
acorn_mod1 <- lm(kwh~Acorn*LCLid, data)
tidy(acorn_mod1)
glance(acorn_mod1)
```
---
```{r, echo=FALSE}
ggplot(data = data) +
  geom_line(mapping = aes(x=day, y=kwh, colour=LCLid)) +
  facet_wrap(~Acorn)
```
This reinforces the idea that there is larger variation within the electricity usage for Acorn A households, while for Acorn Q, the electricity usage is much lower but much more consistent. 
---
# 4. CONCLUSION

- For ACORN-A households, we can see that the kwh usage can be explained by year, month, days, time and household. 
- This tells us that across each year, month, time and day, all the ACORN A households, on average, will have a change in their electricity usage. 
- More importantly, we can see that the interactions of each household by time, month, year and day and they are significant. 
- This tells us that each household changes their usage based on these variables, which seems intuitive as each household will use their electricity differently during varying times based on their type of tariff and also their personal preferences which can be systematically captured within the LCLid variable. 

