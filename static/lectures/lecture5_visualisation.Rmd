---
title: "ETC1010: Data Modelling and Computing"
subtitle: 'Lecture 5: Plotting your data'
author: "Di Cook (dicook@monash.edu, @visnut)"
date: "Week 5"
output:
  xaringan::moon_reader:
    css: ["default", "myremark.css"]
    self_contained: false
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r, echo = FALSE, warning = FALSE, message=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  echo=FALSE,
  comment = "",
  fig.height = 4,
  fig.width = 8,
  fig.align = "center",
  cache = FALSE
)
library(tidyverse)
library(gridExtra)
library(plotly)
library(ggthemes)
library(ggmap)
library(lubridate)
```

# Overview

- Grammar of graphics
    + Chloropleth Maps
    + Networks
    + Multivariate plots


---
# Maps

- Maps are basically point data sets, with lines connecting dots in special order, and groups, yielding polygons defining geographic regions
- To fill polygons with colour corresponding to a variable, requires joining map data with data table
- Geographic regions often have multiple names, which may not match in the different tables

---
# OECD PISA data

- About 500,000 students
- Approx 20,000 schools
- Around 70 countries tested every 3 years on reading, writing and science.
- Nearly 1000 variables collected on each student, and more on parents and schools

---
# Gender gap

- We often hear in the news that boys perform better than girls in math
- Examine this by taking the PISA scores, compute the average for boys and girls, and difference these for each country. The calculations use a weighted mean, because each student in the study has a sampling weight associated with them, indicating how representative they are of their demographic in the country.


```{r read_data, eval=FALSE}
library(haven)
pisa_2015 <- read_sav(file.choose()) # The SPSS format zip file

library(sqldf)
library(DBI)
db <- dbConnect(SQLite(), dbname="PISA.sqlite")

library(ISOcodes)
data("ISO_3166_1")

scores <- tb %>% 
  select(CNT, ST004D01T, PV1MATH, PV1READ, PV1SCIE, SENWT) %>% collect()
scores <- scores %>% 
  mutate(CNT=recode(CNT, "QES"="ESP", "QCH"="CHN", "QAR"="ARG", "TAP"="TWN")) %>%
  filter(CNT != "QUC") %>%
  filter(CNT != "QUD") %>%
  filter(CNT != "QUE")
countries <- scores %>%
  left_join(ISO_3166_1, by=c("CNT"="Alpha_3"))
countries$Name[countries$CNT == "KSV"] <- "Kosovo"
countries <- countries %>% 
  mutate(ST004D01T=factor(ST004D01T, levels=c(1,2), labels=c("female","male")))
score_gap <- countries %>% 
  group_by(Name) %>%
  summarise(wmathgap=weighted.mean(PV1MATH[ST004D01T=="male"],
                       w=SENWT[ST004D01T=="male"], na.rm=T)-
                     weighted.mean(PV1MATH[ST004D01T=="female"],
                       w=SENWT[ST004D01T=="female"], na.rm=T),
            wreadgap=weighted.mean(PV1READ[ST004D01T=="male"],
                       w=SENWT[ST004D01T=="male"], na.rm=T)-
                     weighted.mean(PV1READ[ST004D01T=="female"],
                       w=SENWT[ST004D01T=="female"], na.rm=T),
            wsciegap=weighted.mean(PV1SCIE[ST004D01T=="male"],
                       w=SENWT[ST004D01T=="male"], na.rm=T)-
                     weighted.mean(PV1SCIE[ST004D01T=="female"],
                       w=SENWT[ST004D01T=="female"], na.rm=T))
write_csv(score_gap, path="pisa_gap.csv")
```

---
# Display means

```{r fig.height=7, fig.width=8, fig.align='center'}
library(forcats)
pisa_gap <- read_csv("data/pisa_gap.csv")
pisa_gap <- pisa_gap %>% 
  mutate(Name = fct_reorder(Name, wmathgap)) %>%
  mutate(direction=ifelse(wmathgap>0, "boys", "girls")) 
ggplot(pisa_gap, aes(x=wmathgap, y=Name, colour=direction)) +
  geom_vline(xintercept=0, colour="white", size=2) +
  geom_point() +
  scale_colour_manual(values=c("#D95F02", "#1B9E77")) +
  xlab("Math Gap") + ylab("") +
  theme(legend.position="none") + xlim(c(-30, 30))
```

---
# Country labels

Original labels for countries are the three letter code:

```
> scores
# A tibble: 514,397 x 6
     CNT ST004D01T PV1MATH PV1READ PV1SCIE SENWT
   <chr>     <dbl>   <dbl>   <dbl>   <dbl> <dbl>
 1   ALB         1 462.940 429.846 517.092 2.181
 2   ALB         1 430.100 462.788 479.635 2.181
 3   ALB         1 302.612 503.169 446.930 2.181
```

---
# Map

The maps ofetn have actual country names as the labels for each geographic polygon:

```{r}
world_map <- map_data("world")
head(world_map)
```

---
# ISO data base

```{r echo=TRUE}
library(ISOcodes)
data("ISO_3166_1")
ISO_3166_1 %>% select(Alpha_3, Name) %>% head()
```

---
# Join the PISA and ISO codes

```{r echo=TRUE, eval=FALSE}
scores <- tb %>% 
  select(CNT, ST004D01T, PV1MATH, PV1READ, PV1SCIE, SENWT) %>% collect()
scores <- scores %>% 
  mutate(CNT=recode(CNT, "QES"="ESP", "QCH"="CHN", "QAR"="ARG", "TAP"="TWN")) %>%
  filter(CNT != "QUC") %>%
  filter(CNT != "QUD") %>%
  filter(CNT != "QUE")
countries <- scores %>%
  left_join(ISO_3166_1, by=c("CNT"="Alpha_3"))
countries$Name[countries$CNT == "KSV"] <- "Kosovo"
```

```
> countries
# A tibble: 514,397 x 7
     CNT ST004D01T PV1MATH PV1READ PV1SCIE SENWT    Name
   <chr>     <dbl>   <dbl>   <dbl>   <dbl> <dbl>   <chr>
 1   ALB         1 462.940 429.846 517.092 2.181 Albania
 2   ALB         1 430.100 462.788 479.635 2.181 Albania
 3   ALB         1 302.612 503.169 446.930 2.181 Albania
 4   ALB         1 336.522 569.626 383.794 2.181 Albania
 5   ALB         1 290.929 389.138 412.304 2.181 Albania
```

---
# Still some mismatches

In the PISA data:

```{r echo=TRUE}
pisa_gap <- pisa_gap %>%
  mutate(Name = recode(Name, "Czechia"="Czech Republic",
                       "Korea, Republic of"="South Korea",
                       "Macedonia, Republic of"="Macedonia",
                       "Moldova, Republic of"="Moldova",
                       "Russian Federation"="Russia",
                       "Taiwan, Province of China"="Taiwan",
                       "Trinidad and Tobago"="Trinidad",
                       "United States"="USA",
                       "United Kingdom"="UK",
                       "Viet Nam"="Vietnam"))
```

In the map data:

```{r echo=TRUE}
world_map$region[world_map$subregion == "Hong Kong"] <- "Hong Kong"
world_map$region[world_map$subregion == "Macao"] <- "Macao"
```

Now join:

```{r echo=TRUE}
to_map <- left_join(world_map, pisa_gap, by=c("region"="Name"))
```

---
# Map it!

```{r echo=TRUE, eval=FALSE}
ggplot(to_map, aes(map_id = region)) + 
    geom_map(aes(fill=wmathgap), map = world_map, 
             color="grey70", size=0.1) + 
    scale_fill_gradient2("Math gap", limits=c(-35, 35), na.value="grey99",
                         low="#1B9E77", high="#D95F02", mid="white") +
    expand_limits(x = world_map$long, y = world_map$lat) +
    theme_few() +
    theme(legend.position = "bottom",
          legend.key.width=unit(1.5, "cm"), 
         axis.ticks = element_blank(), 
         axis.title = element_blank(), 
         axis.text =  element_blank()) 
```

---

```{r fig.width=10, fig.height=6, fig.align='center'}
ggplot(to_map, aes(map_id = region)) + 
    geom_map(aes(fill=wmathgap), map = world_map, 
             color="grey70", size=0.1) + 
    scale_fill_gradient2("Math gap", limits=c(-35, 35), na.value="grey99",
                         low="#1B9E77", high="#D95F02", mid="white") +
    expand_limits(x = world_map$long, y = world_map$lat) +
    theme_few() +
    theme(legend.position = "bottom",
          legend.key.width=unit(1.5, "cm"), 
         axis.ticks = element_blank(), 
         axis.title = element_blank(), 
         axis.text =  element_blank()) 
```

---
# Networks

Network data arises in many settings, e.g. study of communities, biological pathways, ... Typically the data is provided in two related tables, nodes and edges. Both may have additional attributes.

Here's an example from the TV series Madmen. The nodes data contains the actors in the series, and the edges contains pairs of actors that had romantic relationships.

```{r}
library(geomnet)
data(madmen)
glimpse(madmen)
```

---
# Generate a network view

- Create a layout (in 2D) which places nodes which are most related close,
- Plot the nodes as points, connect the appropriate lines
- Overlaying other aspects, e.g. gender

```{r fig.width=8, fig.height=6}
# data step: join the edge and node data with a fortify call
MMnet <- fortify(as.edgedf(madmen$edges), madmen$vertices)
# create plot
set.seed(10052016)
ggplot(data = MMnet, aes(from_id = from_id, to_id = to_id)) +
  geom_net(aes(colour = Gender), layout.alg = "kamadakawai",
    size = 2, labelon = TRUE, vjust = -0.6, ecolour = "grey60",
    directed =FALSE, fontsize = 3, ealpha = 0.5) +
    scale_colour_manual(values = c("#FF69B4", "#0099ff")) +
    xlim(c(-0.05, 1.05)) +
    theme_net() +
    theme(legend.position = "bottom")
```


---
# American college football


```{r echo=TRUE}
glimpse(football)
```

---

```{r fig.width=11, fig.height=8, fig.align='center'}
# data step: merge vertices and edges
ftnet <- merge(
  football$edges, football$vertices,
  by.x = "from", by.y = "label", all = TRUE
)

# label independent schools
ftnet$schools <- ifelse(ftnet$value == "Independents", ftnet$from, "")
ggplot(data = ftnet,
       aes(from_id = from, to_id = to)) +
  geom_net(
    aes(
      colour = value, group = value,
      linetype = factor(1-same.conf),
      label = schools
    ),
    linewidth = 0.5,
    size = 5, vjust = -0.75, alpha = 0.3,
    layout.alg = 'fruchtermanreingold'
  ) +
  theme_net() +
  theme(legend.position = "bottom") +
  scale_colour_brewer("Conference", palette = "Paired")
```

---
# Getting beyond 2D

- Pairs of variables in a matrix layout: pairs plots or scatterplot matrix
- Parallel axes instead of orthogonal axes

---
# Pairs plots

```{r fig.width=10, fig.height=7}
library(GGally)
nrc <- read_csv("data/nrc.csv") %>%
  select(S.Rankings.5th.Percentile, R.Rankings.5th.Percentile,
         Median.Time.to.Degree, Student.Work.Space, Prizes.Awards) %>%
  rename(S.5th=S.Rankings.5th.Percentile,
         R.5th=R.Rankings.5th.Percentile,
         Time.to.Grad=Median.Time.to.Degree, 
         Workspace=Student.Work.Space) %>%
  mutate(Workspace=recode(Workspace, "-1"="<100%", "1"="100%"),
         Prizes.Awards=recode(Prizes.Awards, 
              "1"="None", "2"="Prog", "3"="Inst", "4"="Both")) %>%
  filter(!is.na(Time.to.Grad)) %>%
  filter(Time.to.Grad < 10)
ggpairs(nrc, lower=list(combo="facetdensity"), upper=list(combo="box"), title = "NRC Statistics")
```

---
# All variables are numeric

```{r fig.width=7, fig.height=7}
data(flea)
ggscatmat(flea, columns = 2:5, color = "species")
```

---
# Parallel coordinate plot

```{r}
data(diamonds, package="ggplot2")
diamonds.samp <- diamonds[sample(1:dim(diamonds)[1], 100), ]
ggparcoord(data = diamonds.samp, columns = c(1, 5:10))
```

---
# Resources

- Tyner, Briatte, Hofmann (2015) [Network Visualization with ggplot2](http://rjournal.github.io/archive/2017-1/RJ-2017-1.pdf)
- Pairs plots, parallel coordinate plots, and [methods for high-d data](http://ggobi.org/book/index.html) 

---
class: inverse middle 
# Share and share alike

<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.

