---
title: "ETC1010: Advanced Modeling"
subtitle: "Model building"
author: "Di Cook (dicook@monash.edu, @visnut)"
date: "10/10/2017"
output:
  xaringan::moon_reader:
    css: ["default", "myremark.css"]
    self_contained: false
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---


```{r, echo = FALSE, warning = FALSE, message=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  echo=FALSE,
  comment = "",
  fig.height = 4,
  fig.width = 10,
  fig.align = "center",
  cache = FALSE
)
library(tidyverse)
library(gridExtra)
library(plotly)
library(ggthemes)
library(broom)
library(rpart)
library(modelr)
library(viridis)
options(na.action = na.warn)
```

# Outline

- Diamonds data case study
- Looks like low quality diamonds are more expensive
- Relationship with size
- What factors affect diamond price?

---
# Expensive low quality diamonds

```{r}
p1 <- ggplot(diamonds, aes(cut, price)) + geom_boxplot()
p2 <- ggplot(diamonds, aes(color, price)) + geom_boxplot()
p3 <- ggplot(diamonds, aes(clarity, price)) + geom_boxplot()
grid.arrange(p1, p2, p3, ncol=3)
```

Worst diamond color is J (slightly yellow), and the worst clarity is I1 (inclusions visible to the naked eye).

---
# Taking size into account

```{r fig.width=12}
p1 <- ggplot(diamonds, aes(carat, price)) + geom_point() +
  theme(aspect.ratio=1)
diamonds2 <- diamonds %>% filter(carat <= 2.5) %>% 
  mutate(lprice = log2(price), lcarat = log2(carat))
p2 <- ggplot(diamonds2, aes(lcarat, lprice)) + geom_point() +
  theme(aspect.ratio=1)
p3 <- ggplot(diamonds2, aes(lcarat, lprice)) + 
  geom_hex(bins = 50) + scale_fill_viridis() +
  theme(aspect.ratio=1, legend.position="bottom")
grid.arrange(p1, p2, p3, ncol=3)
```

- Very few diamonds bigger than 2.5 carats, insufficient support for modeling large diamonds. 
- Putting both variables on a log scale linearises the relationship.
- Lots of observations, hexbin provides insight in the highest density

```
diamonds2 <- diamonds %>% 
  filter(carat <= 2.5) %>% 
  mutate(lprice = log2(price), lcarat = log2(carat))
```

---
# Model

.pull-left[
```{r echo=TRUE}
mod_diamond <- lm(lprice ~ 
  lcarat, data = diamonds2)
grid <- diamonds2 %>% 
  data_grid(carat = 
    seq_range(carat, 20)) %>% 
  mutate(lcarat = log2(carat)) %>% 
  add_predictions(mod_diamond, 
                  "lprice") %>% 
  mutate(price = 2 ^ lprice)
```

Linear fit, but the reverse transformation puts fitted model back into original scale. 
]

.pull-right[
```{r fig.width=4, fig.height=4}
ggplot(diamonds2, 
       aes(carat, price)) + 
  geom_hex(bins = 50) + 
  scale_fill_viridis() +
  geom_line(data = grid, 
            colour = "red", 
            size = 1) +
  theme(aspect.ratio=1, 
        legend.position="none")
```

At the bigger diamonds, all prices are lower than the fitted line, suggesting that they are cheaper than expected. But this is structural, the data available does not have any diamonds costing more than $19,000.
]

---
# Check residuals

```{r fig.width=6}
diamonds2 <- diamonds2 %>% 
  add_residuals(mod_diamond, "lresid")

ggplot(diamonds2, aes(lcarat, lresid)) + 
  geom_hex(bins = 50) + 
  scale_fill_viridis()
```

Pretty good. There is a little under-fitting for small diamonds and overfitting of larger diamonds.

---
# Relationship with quality variables

Price is adjusted for carat.

```{r}
p1 <- ggplot(diamonds2, aes(cut, lresid)) + geom_boxplot()
p2 <- ggplot(diamonds2, aes(color, lresid)) + geom_boxplot()
p3 <- ggplot(diamonds2, aes(clarity, lresid)) + geom_boxplot()
grid.arrange(p1, p2, p3, ncol=3)
```

Relationship is now as expected: price increases with cut quality, and is small for color J, and visible flaws I1.

---
# Build into a single model

Two ways cut, color, clarity handled - MAKES A DIFFERENCE IN MODEL

```{r echo=TRUE}
diamonds3 <- diamonds2 
diamonds3$cut <- factor(diamonds3$cut, ordered = FALSE)
diamonds3$color <- factor(diamonds3$color, ordered = FALSE)
diamonds3$clarity <- factor(diamonds3$clarity, ordered = FALSE)
is.ordered(diamonds2$cut)
is.ordered(diamonds3$cut)
```

Ordered factors will be fit as numeric `cut=1, 2, 3, 4, 5`, but unordered factors will be fit as *dummy* variables. Dummy variables recode the `k` levels of a factor into `k-1` new variables containing binary values (1 if the observation has that level, and 0 otherwise). Dummy variables are more flexible. For example, 

.pull-left[
```
obs  catvar1
1   A
2   A
3   B
4   C
```
]

.pull-right[
```
obs catvar1_A catvar1_B catvar1_C
1   1         0         0
2   1         0         0
3   0         1         0
4   0         0         1
````
]

---
# Build into a single model

```{r echo=TRUE, results=FALSE}
mod_diamond2 <- lm(lprice ~ lcarat + color + cut + clarity, data = diamonds2)
summary(mod_diamond2)
```

```{r echo=TRUE, results=FALSE}
mod_diamond3 <- lm(lprice ~ lcarat + color + cut + clarity, data = diamonds3)
summary(mod_diamond3)
```

Both models provide an extremely good fit. $R^2$ close to 1, and suggest that all three categorical variables, and their levels are important for predicting price. 
---
# Ordered factors

```
Coefficients:
             Estimate Std. Error  t value Pr(>|t|)    
(Intercept) 12.206978   0.001693 7211.806  < 2e-16 ***
lcarat       1.886239   0.001124 1677.809  < 2e-16 ***
color.L     -0.633998   0.002910 -217.872  < 2e-16 ***
color.Q     -0.137580   0.002676  -51.409  < 2e-16 ***
color.C     -0.022072   0.002503   -8.819  < 2e-16 ***
color^4      0.016570   0.002297    7.213 5.54e-13 ***
color^5     -0.002828   0.002169   -1.304    0.192    
color^6      0.003533   0.001971    1.793    0.073 .  
cut.L        0.173866   0.003386   51.349  < 2e-16 ***
cut.Q       -0.050346   0.002980  -16.897  < 2e-16 ***
cut.C        0.019129   0.002583    7.407 1.31e-13 ***
cut^4       -0.002410   0.002066   -1.166    0.243    
clarity.L    1.308155   0.005179  252.598  < 2e-16 ***
clarity.Q   -0.334090   0.004839  -69.047  < 2e-16 ***
clarity.C    0.178423   0.004140   43.093  < 2e-16 ***
clarity^4   -0.088059   0.003298  -26.697  < 2e-16 ***
clarity^5    0.035885   0.002680   13.389  < 2e-16 ***
clarity^6   -0.001371   0.002327   -0.589    0.556    
clarity^7    0.048221   0.002051   23.512  < 2e-16 ***
---

Residual standard error: 0.1916 on 53795 degrees of freedom
Multiple R-squared:  0.9828,	Adjusted R-squared:  0.9828 
F-statistic: 1.706e+05 on 18 and 53795 DF,  p-value: < 2.2e-16
```

---
# Dummy variables

```
Coefficients:
              Estimate Std. Error t value Pr(>|t|)    
(Intercept)  11.366696   0.008403 1352.76   <2e-16 ***
lcarat        1.886239   0.001124 1677.81   <2e-16 ***
colorE       -0.078489   0.003034  -25.87   <2e-16 ***
colorF       -0.137370   0.003068  -44.78   <2e-16 ***
colorG       -0.232097   0.003003  -77.29   <2e-16 ***
colorH       -0.362063   0.003188 -113.56   <2e-16 ***
colorI       -0.537257   0.003573 -150.36   <2e-16 ***
colorJ       -0.737525   0.004417 -166.99   <2e-16 ***
cutGood       0.114935   0.005596   20.54   <2e-16 ***
cutVery Good  0.168393   0.005206   32.34   <2e-16 ***
cutPremium    0.200701   0.005150   38.97   <2e-16 ***
cutIdeal      0.232023   0.005105   45.45   <2e-16 ***
claritySI2    0.589367   0.007572   77.84   <2e-16 ***
claritySI1    0.825861   0.007525  109.75   <2e-16 ***
clarityVS2    1.041576   0.007564  137.71   <2e-16 ***
clarityVS1    1.142960   0.007674  148.94   <2e-16 ***
clarityVVS2   1.338362   0.007898  169.45   <2e-16 ***
clarityVVS1   1.441974   0.008117  177.65   <2e-16 ***
clarityIF     1.579102   0.008758  180.30   <2e-16 ***
---

Residual standard error: 0.1916 on 53795 degrees of freedom
Multiple R-squared:  0.9828,	Adjusted R-squared:  0.9828 
F-statistic: 1.706e+05 on 18 and 53795 DF,  p-value: < 2.2e-16
```

---
# Plot residuals

```{r fig.width=6}
diamonds3 <- diamonds3 %>% 
  add_residuals(mod_diamond3, "lresid3")
ggplot(diamonds3, aes(lcarat, lresid3)) + 
  geom_hex(bins = 50) + 
  scale_fill_viridis()
```

There are a few outliers that need to be inspected.

---
# Check outliers

```{r}
diamonds3 %>% 
  filter(abs(lresid3) > 1) %>% 
  add_predictions(mod_diamond3) %>% 
  mutate(pred = round(2 ^ pred)) %>% 
  select(price, pred, carat:table, x:z) %>% 
  arrange(price)
```

---
# Plot model

.pull-left[
ORDERED

```{r fig.height=7}
diamonds2 <- diamonds2 %>% add_predictions(mod_diamond2) %>% 
  mutate(pred = round(2 ^ pred))
ggplot(diamonds2, aes(x=carat, y=pred, colour=cut)) +
  geom_line() + facet_grid(color~clarity)
```
]

.pull-right[
UNORDERED

```{r fig.height=7}
diamonds3 <- diamonds3 %>% add_predictions(mod_diamond3) %>% 
  mutate(pred = round(2 ^ pred))
ggplot(diamonds3, aes(x=carat, y=pred, colour=cut)) +
  geom_line() + facet_grid(color~clarity)
```
]

No effective difference in model, but dummy variable model is easier to explain. Also, doesn't look like cut makes much difference in price.

---
# Color by clarity

cut is only visible as different lines. 

```{r fig.height=5}
ggplot(diamonds3, aes(x=carat, y=pred, colour=color, 
                      group=interaction(cut, color))) +
  geom_line() + facet_wrap(~clarity, ncol=4)
```

Multiple lines are due to cut. Roughly follows order of color quality: J lowest quality, D highest. For same size diamond, on average price is higher with better color. Curves are flatter in clarity I1.

---
# Clarity by color

cut is only visible as different lines. 

```{r fig.height=5}
ggplot(diamonds3, aes(x=carat, y=pred, colour=clarity, 
                      group=interaction(cut, clarity))) +
  geom_line() + facet_wrap(~color, ncol=4)
```

Clarity I1 is very different, and costs a lot less on average than all other clarity values.

---
# Model equations

```{r}
coef <- coef(summary(mod_diamond2))
```

The model is basically price by carat. Focus on these values and adjust coefficients for each combination of the categories of other variables. 

```
For color D, cut Fair, clarity I1, 
  estimated log2(price) = 11.366696 + 1.886239 log2(carat)
```

In original scale

```
estimated price = 2^(11.366696 + 1.886239 log2(carat))
```

Suppose `carat=1.5` then `estimated price=2^(11.366696 + 1.886239x0.5849625) = 5673.723`

---
# Compare with clarity SI2

```
For color D, cut Fair, clarity I1, 
  estimated log2(price) = 11.366696 + 1.886239 log2(carat)
```

```
For color D, cut Fair, clarity SI2, 
  estimated log2(price) = 11.366696 + 0.589367 + 1.886239 log2(carat)
```

Suppose `carat=1.5` then `estimated price=2^(11.366696 + 0.589367 + 1.886239x0.5849625) = 8536.565`

This is about a 150% increase in price. 

From SI2 to SI1, the average price is 10057.19, which represents a 118% increase, not quite as much. 

---
# Effect of different cut is small

For color=D, clarity SI2 a 1.5 carat diamond with 

`cut=Fair
  estimated log2(price) = 11.366696 + 0.589367 + 1.886239 log2(carat)
cut=Good
  estimated log2(price) = 11.366696 + 0.589367 + 0.114935 + 1.886239 log2(carat)`

The estimated price for a Fair cut is $8536.58, and for a Good cut is $9244.48, which is a 108% increase, not a big change.

---
# More complex model

Interaction terms allow the slope to also change. 

```{r echo=TRUE, results=FALSE}
mod_diamond4 <- lm(lprice ~ lcarat + color + cut + lcarat*clarity, data = diamonds3)
summary(mod_diamond4)
```

```
Coefficients:
                    Estimate Std. Error t value Pr(>|t|)    
(Intercept)        11.395864   0.008540 1334.42   <2e-16 ***
lcarat              1.678273   0.012059  139.17   <2e-16 ***
...
claritySI2          0.561018   0.007721   72.66   <2e-16 ***
...
clarityIF           1.546910   0.011677  132.47   <2e-16 ***
lcarat:claritySI2   0.210659   0.012369   17.03   <2e-16 ***
lcarat:claritySI1   0.224168   0.012246   18.31   <2e-16 ***
lcarat:clarityVS2   0.196629   0.012237   16.07   <2e-16 ***
lcarat:clarityVS1   0.213054   0.012334   17.27   <2e-16 ***
lcarat:clarityVVS2  0.212561   0.012537   16.95   <2e-16 ***
lcarat:clarityVVS1  0.189182   0.012910   14.65   <2e-16 ***
lcarat:clarityIF    0.204820   0.013721   14.93   <2e-16 ***
---

Residual standard error: 0.1909 on 53788 degrees of freedom
Multiple R-squared:  0.9829,	Adjusted R-squared:  0.9829 
F-statistic: 1.238e+05 on 25 and 53788 DF,  p-value: < 2.2e-16
```

---
# Interpretation

```
For color D, cut Fair, clarity I1, 
  estimated log2(price) = 11.395864 + 1.678273 log2(carat)
```

```
For color D, cut Fair, clarity SI2, 
  estimated log2(price) = 11.395864 + 0.561018 + 
                           (1.678273+0.210659) log2(carat)
```

Suppose `carat=1.5` then I1 diamond is estimated to be $5321.40, and SI2 is estimated to be $8550.76, about 160% increase. 

---

Model looks like (orange=I1, red=SI2):

```{r fig.height=6}
df <- data.frame(carat=seq(0.25, 2.5, 0.25), 
                 lcarat=log2(seq(0.25, 2.5, 0.25)), 
                 lI1=11.366696 + 1.886239*log2(seq(0.25, 2.5, 0.25)), 
                 lSI2=11.366696 + 0.589367 + 
                           1.886239*log2(seq(0.25, 2.5, 0.25)),
                 I1=2^(11.366696 + 1.886239*log2(seq(0.25, 2.5, 0.25))), 
                 SI2=2^(11.366696 + 0.589367 + 
                           1.886239*log2(seq(0.25, 2.5, 0.25))),
                 lI1i=11.395864 + 0.561018*log2(seq(0.25, 2.5, 0.25)), 
                 lSI2i=11.395864 + 0.561018 + 
                           (1.678273+0.210659)*log2(seq(0.25, 2.5, 0.25)),
                 I1i=2^(11.395864 + 0.561018*log2(seq(0.25, 2.5, 0.25))), 
                 SI2i=2^(11.395864 + 0.561018 + 
                           (1.678273+0.210659)*log2(seq(0.25, 2.5, 0.25))))
p1 <- ggplot(df, aes(x=lcarat, y=lI1)) + geom_line(color="orange") +
  geom_line(aes(y=lSI2), colour="red") + ggtitle("NO interaction: Linear - log variables")
p2 <- ggplot(df, aes(x=carat, y=I1)) + geom_line(color="orange") +
  geom_line(aes(y=SI2), colour="red") + ggtitle("NO interaction: original variables")
p3 <- ggplot(df, aes(x=lcarat, y=lI1i)) + geom_line(color="orange") +
  geom_line(aes(y=lSI2i), colour="red") + ggtitle("With interaction: Linear - log variables")
p4 <- ggplot(df, aes(x=carat, y=I1i)) + geom_line(color="orange") +
  geom_line(aes(y=SI2i), colour="red") + ggtitle("With interaction: original variables")
grid.arrange(p1, p2, p3, p4, ncol=2)
```

The interaction term changes the slope in the linear fit. 

For this problem its probably not necessary, because the gain in $R^2$ is 0.9829 from 0.9828. 

---
# Summary

- Deciding when to stop tweaking the model is hard - everyone struggles with this
- Make pictures, make pictures, make pictures
- Plot the data, as well as the model, and ideally the model overlaid on the data

```{r fig.height=4, fig.width=7}
df_m <- df %>% gather(clarity, lprice, lI1, lSI2) %>%
  select(lprice, lcarat, clarity) %>%
  mutate(clarity=sub("l", "", clarity))
p1 <- ggplot(filter(diamonds3, clarity %in% c("I1", "SI2"), 
                    color == "D", cut == "Fair"), 
       aes(x=lcarat, y=lprice, colour=clarity)) + 
  geom_point(alpha=0.5) +
  geom_line(data=df_m, aes(x=lcarat, y=lprice, colour=clarity), size=1) +
  scale_colour_manual(values=c("red", "orange")) + facet_wrap(~clarity, ncol=2) + ggtitle("No interaction")
df_m <- df %>% gather(clarity, lprice, lI1i, lSI2i) %>%
  select(lprice, lcarat, clarity) %>%
  mutate(clarity=sub("l", "", clarity)) %>%
  mutate(clarity=sub("i", "", clarity))
p2 <- ggplot(filter(diamonds3, clarity %in% c("I1", "SI2"), 
                    color == "D", cut == "Fair"), 
       aes(x=lcarat, y=lprice, colour=clarity)) + 
  geom_point(alpha=0.5) +
  geom_line(data=df_m, aes(x=lcarat, y=lprice, colour=clarity), size=1) +
  scale_colour_manual(values=c("red", "orange")) + facet_wrap(~clarity, ncol=2) + ggtitle("With interaction")
grid.arrange(p1, p2, ncol=1)
```

---
class: inverse middle 
# Share and share alike

<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.

