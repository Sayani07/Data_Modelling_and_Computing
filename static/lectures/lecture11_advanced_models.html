<!DOCTYPE html>
<html>
  <head>
    <title>ETC1010: Advanced Modeling</title>
    <meta charset="utf-8">
    <meta name="author" content="Di Cook (dicook@monash.edu, @visnut)" />
    <meta name="date" content="2017-10-10" />
    <link href="lecture11_advanced_models_files/remark-css-0.0.1/example.css" rel="stylesheet" />
    <link rel="stylesheet" href="myremark.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# ETC1010: Advanced Modeling
## Model building
### Di Cook (<a href="mailto:dicook@monash.edu">dicook@monash.edu</a>, <span class="citation">@visnut</span>)
### 10/10/2017

---





# Outline

- Diamonds data case study
- Looks like low quality diamonds are more expensive
- Relationship with size
- What factors affect diamond price?

---
# Expensive low quality diamonds

&lt;img src="lecture11_advanced_models_files/figure-html/unnamed-chunk-2-1.png" style="display: block; margin: auto;" /&gt;

Worst diamond color is J (slightly yellow), and the worst clarity is I1 (inclusions visible to the naked eye).

---
# Taking size into account

&lt;img src="lecture11_advanced_models_files/figure-html/unnamed-chunk-3-1.png" style="display: block; margin: auto;" /&gt;

- Very few diamonds bigger than 2.5 carats, insufficient support for modeling large diamonds. 
- Putting both variables on a log scale linearises the relationship.
- Lots of observations, hexbin provides insight in the highest density

```
diamonds2 &lt;- diamonds %&gt;% 
  filter(carat &lt;= 2.5) %&gt;% 
  mutate(lprice = log2(price), lcarat = log2(carat))
```

---
# Model

.pull-left[

```r
mod_diamond &lt;- lm(lprice ~ 
  lcarat, data = diamonds2)
grid &lt;- diamonds2 %&gt;% 
  data_grid(carat = 
    seq_range(carat, 20)) %&gt;% 
  mutate(lcarat = log2(carat)) %&gt;% 
  add_predictions(mod_diamond, 
                  "lprice") %&gt;% 
  mutate(price = 2 ^ lprice)
```

Linear fit, but the reverse transformation puts fitted model back into original scale. 
]

.pull-right[
&lt;img src="lecture11_advanced_models_files/figure-html/unnamed-chunk-5-1.png" style="display: block; margin: auto;" /&gt;

At the bigger diamonds, all prices are lower than the fitted line, suggesting that they are cheaper than expected. But this is structural, the data available does not have any diamonds costing more than $19,000.
]

---
# Check residuals

&lt;img src="lecture11_advanced_models_files/figure-html/unnamed-chunk-6-1.png" style="display: block; margin: auto;" /&gt;

Pretty good. There is a little under-fitting for small diamonds and overfitting of larger diamonds.

---
# Relationship with quality variables

Price is adjusted for carat.

&lt;img src="lecture11_advanced_models_files/figure-html/unnamed-chunk-7-1.png" style="display: block; margin: auto;" /&gt;

Relationship is now as expected: price increases with cut quality, and is small for color J, and visible flaws I1.

---
# Build into a single model

Two ways cut, color, clarity handled - MAKES A DIFFERENCE IN MODEL


```r
diamonds3 &lt;- diamonds2 
diamonds3$cut &lt;- factor(diamonds3$cut, ordered = FALSE)
diamonds3$color &lt;- factor(diamonds3$color, ordered = FALSE)
diamonds3$clarity &lt;- factor(diamonds3$clarity, ordered = FALSE)
is.ordered(diamonds2$cut)
[1] TRUE
is.ordered(diamonds3$cut)
[1] FALSE
```

Ordered factors will be fit as numeric `cut=1, 2, 3, 4, 5`, but unordered factors will be fit as *dummy* variables. Dummy variables recode the `k` levels of a factor into `k-1` new variables containing binary values (1 if the observation has that level, and 0 otherwise). Dummy variables are more flexible. For example, 

.pull-left[
```
obs  catvar1
1   A
2   A
3   B
4   C
```
]

.pull-right[
```
obs catvar1_A catvar1_B catvar1_C
1   1         0         0
2   1         0         0
3   0         1         0
4   0         0         1
````
]

---
# Build into a single model


```r
mod_diamond2 &lt;- lm(lprice ~ lcarat + color + cut + clarity, data = diamonds2)
summary(mod_diamond2)
```


```r
mod_diamond3 &lt;- lm(lprice ~ lcarat + color + cut + clarity, data = diamonds3)
summary(mod_diamond3)
```

Both models provide an extremely good fit. `\(R^2\)` close to 1, and suggest that all three categorical variables, and their levels are important for predicting price. 
---
# Ordered factors

```
Coefficients:
             Estimate Std. Error  t value Pr(&gt;|t|)    
(Intercept) 12.206978   0.001693 7211.806  &lt; 2e-16 ***
lcarat       1.886239   0.001124 1677.809  &lt; 2e-16 ***
color.L     -0.633998   0.002910 -217.872  &lt; 2e-16 ***
color.Q     -0.137580   0.002676  -51.409  &lt; 2e-16 ***
color.C     -0.022072   0.002503   -8.819  &lt; 2e-16 ***
color^4      0.016570   0.002297    7.213 5.54e-13 ***
color^5     -0.002828   0.002169   -1.304    0.192    
color^6      0.003533   0.001971    1.793    0.073 .  
cut.L        0.173866   0.003386   51.349  &lt; 2e-16 ***
cut.Q       -0.050346   0.002980  -16.897  &lt; 2e-16 ***
cut.C        0.019129   0.002583    7.407 1.31e-13 ***
cut^4       -0.002410   0.002066   -1.166    0.243    
clarity.L    1.308155   0.005179  252.598  &lt; 2e-16 ***
clarity.Q   -0.334090   0.004839  -69.047  &lt; 2e-16 ***
clarity.C    0.178423   0.004140   43.093  &lt; 2e-16 ***
clarity^4   -0.088059   0.003298  -26.697  &lt; 2e-16 ***
clarity^5    0.035885   0.002680   13.389  &lt; 2e-16 ***
clarity^6   -0.001371   0.002327   -0.589    0.556    
clarity^7    0.048221   0.002051   23.512  &lt; 2e-16 ***
---

Residual standard error: 0.1916 on 53795 degrees of freedom
Multiple R-squared:  0.9828,	Adjusted R-squared:  0.9828 
F-statistic: 1.706e+05 on 18 and 53795 DF,  p-value: &lt; 2.2e-16
```

---
# Dummy variables

```
Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  11.366696   0.008403 1352.76   &lt;2e-16 ***
lcarat        1.886239   0.001124 1677.81   &lt;2e-16 ***
colorE       -0.078489   0.003034  -25.87   &lt;2e-16 ***
colorF       -0.137370   0.003068  -44.78   &lt;2e-16 ***
colorG       -0.232097   0.003003  -77.29   &lt;2e-16 ***
colorH       -0.362063   0.003188 -113.56   &lt;2e-16 ***
colorI       -0.537257   0.003573 -150.36   &lt;2e-16 ***
colorJ       -0.737525   0.004417 -166.99   &lt;2e-16 ***
cutGood       0.114935   0.005596   20.54   &lt;2e-16 ***
cutVery Good  0.168393   0.005206   32.34   &lt;2e-16 ***
cutPremium    0.200701   0.005150   38.97   &lt;2e-16 ***
cutIdeal      0.232023   0.005105   45.45   &lt;2e-16 ***
claritySI2    0.589367   0.007572   77.84   &lt;2e-16 ***
claritySI1    0.825861   0.007525  109.75   &lt;2e-16 ***
clarityVS2    1.041576   0.007564  137.71   &lt;2e-16 ***
clarityVS1    1.142960   0.007674  148.94   &lt;2e-16 ***
clarityVVS2   1.338362   0.007898  169.45   &lt;2e-16 ***
clarityVVS1   1.441974   0.008117  177.65   &lt;2e-16 ***
clarityIF     1.579102   0.008758  180.30   &lt;2e-16 ***
---

Residual standard error: 0.1916 on 53795 degrees of freedom
Multiple R-squared:  0.9828,	Adjusted R-squared:  0.9828 
F-statistic: 1.706e+05 on 18 and 53795 DF,  p-value: &lt; 2.2e-16
```

---
# Plot residuals

&lt;img src="lecture11_advanced_models_files/figure-html/unnamed-chunk-11-1.png" style="display: block; margin: auto;" /&gt;

There are a few outliers that need to be inspected.

---
# Check outliers


```
# A tibble: 16 x 11
   price  pred carat       cut  color clarity depth table     x     y
   &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;fctr&gt; &lt;fctr&gt;  &lt;fctr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1  1013   264  0.25      Fair      F     SI2  54.4    64  4.30  4.23
 2  1186   284  0.25   Premium      G     SI2  59.0    60  5.33  5.28
 3  1186   284  0.25   Premium      G     SI2  58.8    60  5.33  5.28
 4  1262  2644  1.03      Fair      E      I1  78.2    54  5.72  5.59
 5  1415   639  0.35      Fair      G     VS2  65.9    54  5.57  5.53
 6  1415   639  0.35      Fair      G     VS2  65.9    54  5.57  5.53
 7  1715   576  0.32      Fair      F     VS2  59.6    60  4.42  4.34
 8  1776   412  0.29      Fair      F     SI1  55.8    60  4.48  4.41
 9  2160   314  0.34      Fair      F      I1  55.8    62  4.72  4.60
10  2366   774  0.30 Very Good      D    VVS2  60.6    58  4.33  4.35
11  3360  1373  0.51   Premium      F     SI1  62.7    62  5.09  4.96
12  3807  1540  0.61      Good      F     SI2  62.5    65  5.36  5.29
13  3920  1705  0.51      Fair      F    VVS2  65.4    60  4.98  4.90
14  4368  1705  0.51      Fair      F    VVS2  60.7    66  5.21  5.11
15 10011  4048  1.01      Fair      D     SI2  64.6    58  6.25  6.20
16 10470 23622  2.46   Premium      E     SI2  59.7    59  8.82  8.76
# ... with 1 more variables: z &lt;dbl&gt;
```

---
# Plot model

.pull-left[
ORDERED

&lt;img src="lecture11_advanced_models_files/figure-html/unnamed-chunk-13-1.png" style="display: block; margin: auto;" /&gt;
]

.pull-right[
UNORDERED

&lt;img src="lecture11_advanced_models_files/figure-html/unnamed-chunk-14-1.png" style="display: block; margin: auto;" /&gt;
]

No effective difference in model, but dummy variable model is easier to explain. Also, doesn't look like cut makes much difference in price.

---
# Color by clarity

cut is only visible as different lines. 

&lt;img src="lecture11_advanced_models_files/figure-html/unnamed-chunk-15-1.png" style="display: block; margin: auto;" /&gt;

Multiple lines are due to cut. Roughly follows order of color quality: J lowest quality, D highest. For same size diamond, on average price is higher with better color. Curves are flatter in clarity I1.

---
# Clarity by color

cut is only visible as different lines. 

&lt;img src="lecture11_advanced_models_files/figure-html/unnamed-chunk-16-1.png" style="display: block; margin: auto;" /&gt;

Clarity I1 is very different, and costs a lot less on average than all other clarity values.

---
# Model equations



The model is basically price by carat. Focus on these values and adjust coefficients for each combination of the categories of other variables. 

```
For color D, cut Fair, clarity I1, 
  estimated log2(price) = 11.366696 + 1.886239 log2(carat)
```

In original scale

```
estimated price = 2^(11.366696 + 1.886239 log2(carat))
```

Suppose `carat=1.5` then `estimated price=2^(11.366696 + 1.886239x0.5849625) = 5673.723`

---
# Compare with clarity SI2

```
For color D, cut Fair, clarity I1, 
  estimated log2(price) = 11.366696 + 1.886239 log2(carat)
```

```
For color D, cut Fair, clarity SI2, 
  estimated log2(price) = 11.366696 + 0.589367 + 1.886239 log2(carat)
```

Suppose `carat=1.5` then `estimated price=2^(11.366696 + 0.589367 + 1.886239x0.5849625) = 8536.565`

This is about a 150% increase in price. 

From SI2 to SI1, the average price is 10057.19, which represents a 118% increase, not quite as much. 

---
# Effect of different cut is small

For color=D, clarity SI2 a 1.5 carat diamond with 

`cut=Fair
  estimated log2(price) = 11.366696 + 0.589367 + 1.886239 log2(carat)
cut=Good
  estimated log2(price) = 11.366696 + 0.589367 + 0.114935 + 1.886239 log2(carat)`

The estimated price for a Fair cut is $8536.58, and for a Good cut is $9244.48, which is a 108% increase, not a big change.

---
# More complex model

Interaction terms allow the slope to also change. 


```r
mod_diamond4 &lt;- lm(lprice ~ lcarat + color + cut + lcarat*clarity, data = diamonds3)
summary(mod_diamond4)
```

```
Coefficients:
                    Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)        11.395864   0.008540 1334.42   &lt;2e-16 ***
lcarat              1.678273   0.012059  139.17   &lt;2e-16 ***
...
claritySI2          0.561018   0.007721   72.66   &lt;2e-16 ***
...
clarityIF           1.546910   0.011677  132.47   &lt;2e-16 ***
lcarat:claritySI2   0.210659   0.012369   17.03   &lt;2e-16 ***
lcarat:claritySI1   0.224168   0.012246   18.31   &lt;2e-16 ***
lcarat:clarityVS2   0.196629   0.012237   16.07   &lt;2e-16 ***
lcarat:clarityVS1   0.213054   0.012334   17.27   &lt;2e-16 ***
lcarat:clarityVVS2  0.212561   0.012537   16.95   &lt;2e-16 ***
lcarat:clarityVVS1  0.189182   0.012910   14.65   &lt;2e-16 ***
lcarat:clarityIF    0.204820   0.013721   14.93   &lt;2e-16 ***
---

Residual standard error: 0.1909 on 53788 degrees of freedom
Multiple R-squared:  0.9829,	Adjusted R-squared:  0.9829 
F-statistic: 1.238e+05 on 25 and 53788 DF,  p-value: &lt; 2.2e-16
```

---
# Interpretation

```
For color D, cut Fair, clarity I1, 
  estimated log2(price) = 11.395864 + 1.678273 log2(carat)
```

```
For color D, cut Fair, clarity SI2, 
  estimated log2(price) = 11.395864 + 0.561018 + 
                           (1.678273+0.210659) log2(carat)
```

Suppose `carat=1.5` then I1 diamond is estimated to be $5321.40, and SI2 is estimated to be $8550.76, about 160% increase. 

---

Model looks like (orange=I1, red=SI2):

&lt;img src="lecture11_advanced_models_files/figure-html/unnamed-chunk-19-1.png" style="display: block; margin: auto;" /&gt;

The interaction term changes the slope in the linear fit. 

For this problem its probably not necessary, because the gain in `\(R^2\)` is 0.9829 from 0.9828. 

---
# Summary

- Deciding when to stop tweaking the model is hard - everyone struggles with this
- Make pictures, make pictures, make pictures
- Plot the data, as well as the model, and ideally the model overlaid on the data

&lt;img src="lecture11_advanced_models_files/figure-html/unnamed-chunk-20-1.png" style="display: block; margin: auto;" /&gt;

---
class: inverse middle 
# Share and share alike

&lt;a rel="license" href="http://creativecommons.org/licenses/by/4.0/"&gt;&lt;img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /&gt;&lt;/a&gt;&lt;br /&gt;This work is licensed under a &lt;a rel="license" href="http://creativecommons.org/licenses/by/4.0/"&gt;Creative Commons Attribution 4.0 International License&lt;/a&gt;.
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {window.dispatchEvent(new Event('resize'));});</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
